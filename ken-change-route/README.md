# OpenFlow-контроллер на OSKen

Скрипт реализует контроллер OpenFlow с использованием фреймворка **OSKen** (аналог Ryu), поддерживающий:
- индивидуальные таблицы маршрутов для коммутаторов;
- установку правил маршрутизации и перенаправления пакетов;
- периодическое изменение маршрутов (динамическая маршрутизация);
- обработку IP и ARP пакетов;
- добавление flow'ов на основе правил из таблицы маршрутизации;
- реагирование на события подключения коммутаторов и поступления пакетов.

## Основные компоненты

### `Controller` (наследуется от `OSKenApp`)

Главный класс приложения контроллера.

### Атрибуты:

- `OFP_VERSIONS` — используется версия OpenFlow 1.3.
- `routing_tables` — словарь с таблицами маршрутизации для каждого коммутатора (по DPID).
- `deflag` — переключатель для динамического изменения маршрута.
- `datapaths` — хранилище datapath-объектов (представляющих коммутаторы).

## Динамическое изменение маршрутов

### Метод: `reroute`

Фоновый процесс (запускается через `hub.spawn`):
- Каждые 10 секунд меняет выходной порт для IP-адреса `10.0.0.3` на коммутаторе `dpid=1`.
- Перезаписывает соответствующее правило в таблице коммутатора.
- Имитация динамической маршрутизации / балансировки нагрузки.

## Обработка событий

### 1. `features_handler` — `EventOFPSwitchFeatures`

Обработка события подключения коммутатора:

- Сохраняет datapath коммутатора в `self.datapaths`.
- Устанавливает поточные правила (`flows`) на основе `routing_tables`:
  - для IP-пакетов (`eth_type=0x0800`);
  - для ARP-запросов (`eth_type=0x0806`).

### 2. `packet_in_handler` — `EventOFPPacketIn`

Обработка поступающих пакетов:

- Для IP-пакетов:
  - Извлекает IP-назначение и определяет маршрут по `routing_tables`.
  - Устанавливает новое правило маршрутизации (`add_flow`) в коммутатор.
  - Отправляет пакет на нужный порт (`OFPPacketOut`).
- Для остальных пакетов:
  - Выполняет FLOOD (широковещательная передача на все порты).

## Установка поточных правил

### Метод: `__add_flow`

Добавляет новое правило в таблицу потока (`Flow Table`) коммутатора:

- Принимает:
  - `match` — условие срабатывания правила;
  - `actions` — список действий (перенаправление, изменение MAC и др.);
  - `priority`, `idle_timeout`, `hard_timeout`.
- Отправляет сообщение `OFPFlowMod` коммутатору.

## Поддерживаемые протоколы

- Ethernet (`eth_type`)
- IPv4
- ARP
- TCP (при наличии `tcp_dst` в таблице маршрутов)

## Пример маршрута из таблицы

```python
"10.0.0.3": (3, "00:00:00:00:00:03", None)
```
